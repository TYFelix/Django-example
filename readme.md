## Deductive Django Website

Django based website deployed serverlessly on AWS using the [Zappa library](https://github.com/Miserlou/Zappa).

## Deployment

### Project Deployment Script - `./project_deploy.sh`

Will deploy and delete CloudFormation stack and all resources required for deployment. Syntax is as follows:

```
./project_deploy.sh <stage> <command> <profile>
```

Where:

*  `<stage>` can be **DEV-name**, **STAGING** or **PRODUCTION** [default: 'STAGING']
*  `<command>` can be **deploy**, **deploy-stack**, **delete** or **deploy-django** (see below) [default: 'deploy']
*  `<profile>` [optional] is the AWSCLI profile to use for credentials and config [default: none]

Notes:

*  The CloudTrail S3 bucket is purposefully not removed when the CloudFormation stacks are deleted to preserve the logs. The bucket needs to be moved or renamed before the stack can be re-deployed for that stage.
*  Use the *deploy-stack* command if you *only* want to update the AWS infrastructure. 
*  Use the *deploy* command if you want to update the AWS infrastructure **and** the Django website. 
*  Use the *delete-django* command if you **only** want to delete the the Django website. 
*  Use the *delete* command if you want to remove the AWS infrastructure **and** the Django website. 

### Template Generation Script - `./generate_templates.py`

Script to automatically generate CloudFormation template required to deploy project on AWS. Two separate CloudFormation stacks are created and deployed, one for our own AWS infrastructure (to serve the static files, provide a bastion server, serverless database etc.) and one for the Zappa deployment. These are named `deductive-website-django-aws-<STAGE>` and `deductive-website-django-zappa-<STAGE>` respectively. This script creates the former. The latter is generated by the Zappa library on running the `project_deploy.sh` script.

This script can be called stand-alone or is called automatically from the *project_deploy.sh* script when a deployment is made.

Outputs generated template to *./templates* directory. Will automatically overwrite any templates of the same names that already exist.

### Zappa Settings Script - `./generate_zappa_settings.py`

This script is called by *project_deploy.sh* and generates the settings file (`zappa_settings.json`) required by the Zappa library.

## Bastion Server

The bastion server is deployed by the `deductive-website-aws-<STAGE>` CloudFormation script and is used to tunnel into the serverless database and also to run remote scripts to generate and load snapshots of the database.

### Tunnelling

To create a tunnel to database on local port 3307:
```bash
ssh -i ~/.ssh/deductive-website-bastion.pem -N -L 3307:deductive-website-<STAGE>-dbcluster.cluster-c6rqhtu3orj7.us-west-2.rds.amazonaws.com:3306 ec2-user@bastion-<STAGE>.deductive.com
```

### Snapshots

Backup snapshots of the `PRODUCTION` and `STAGING` databases are taken automatically every day and stored in S3 with the following prefix and name:
```bash
s3://deductive-website-deploy/database/backups/<DATE>-deductivewebsite-<STAGE>.sql
```

To restore a snapshot do the following:

1.  Go to [AWS System Manager](https://us-west-2.console.aws.amazon.com/systems-manager/home?region=us-west-2#)
2.  Go to [Run Command](https://us-west-2.console.aws.amazon.com/systems-manager/run-command/executing-commands?region=us-west-2) option
3.  Select `Run Command` button
4.  Select `AWS-RunRemoteScript` Command Document
5.  Set **Command Parameters** `Source Type` to `S3`
6.  Set **Command Parameters** `Source Info` to `{"path": "https://s3.amazonaws.com/deductive-website-deploy/database/scripts/deductive_import_database.sh"}`
7.  Set **Command Parameters** `Command Line` to `deductive_import_database.sh <DATE>-deductivewebsite-<STAGE>.sql` (choosing an existing snaphot file that already exists in the `s3://deductive-website-django-deploy/database/backups/` location. Do not include the path - that is already assumed.)
8.  In **Targets** select `Choose instances manually`
9.  Select name of bastion server associated with database to restore to e.g. `deductive-website-bastion-server-<STAGE>`
10.  In **Output options** deselect `Enable writing to an S3 bucket` and select `CloudWatch output` instead
11.  **Double check you are restoring to the intended destination as this operation will wipe the existing database!!!**
12.  Hit the `Run` button
